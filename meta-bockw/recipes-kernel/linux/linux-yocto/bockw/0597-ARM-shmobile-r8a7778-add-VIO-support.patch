From d9df3c44c934f26142fba115102f2995c1147b10 Mon Sep 17 00:00:00 2001
From: Yusuke Goda <yusuke.goda.sx@renesas.com>
Date: Wed, 12 Jun 2013 17:11:54 +0900
Subject: [PATCH 597/611] ARM: shmobile: r8a7778: add VIO support

Signed-off-by: Yusuke Goda <yusuke.goda.sx@renesas.com>
---
 arch/arm/mach-shmobile/board-bockw.c          |  3 ++
 arch/arm/mach-shmobile/include/mach/common.h  |  1 +
 arch/arm/mach-shmobile/include/mach/r8a7778.h |  1 +
 arch/arm/mach-shmobile/setup-r8a7778.c        | 42 +++++++++++++++++++++++++++
 4 files changed, 47 insertions(+)

diff --git a/arch/arm/mach-shmobile/board-bockw.c b/arch/arm/mach-shmobile/board-bockw.c
index c493dfd..436e6d7 100644
--- a/arch/arm/mach-shmobile/board-bockw.c
+++ b/arch/arm/mach-shmobile/board-bockw.c
@@ -25,6 +25,7 @@
 #include <linux/pinctrl/machine.h>
 #include <linux/platform_device.h>
 #include <linux/platform_data/rcar-du.h>
+#include <linux/platform_data/uio_dmem_genirq.h>
 #include <linux/regulator/fixed.h>
 #include <linux/regulator/machine.h>
 #include <linux/smsc911x.h>
@@ -492,6 +493,7 @@ static void __init bockw_init(void)
 	r8a7778_add_ipmmu_device(&ipmmu_plat);
 	r8a7778_add_vpc_device(&vpc_plat);
 	r8a7778_add_meram_device(&meram_plat);
+	r8a7778_add_vio_device();
 	platform_device_register_data(&platform_bus, "soc-camera-pdrv", 0,
 				      &iclink0_ml86v7667,
 				      sizeof(iclink0_ml86v7667));
@@ -573,6 +575,7 @@ static const char *bockw_boards_compat_dt[] __initdata = {
 DT_MACHINE_START(BOCKW_DT, "bockw")
 	.init_early	= r8a7778_init_delay,
 	.init_irq	= r8a7778_init_irq_dt,
+	.reserve	= r8a7778_reserve_memory,
 	.init_machine	= bockw_init,
 	.timer		= &shmobile_timer,
 	.dt_compat	= bockw_boards_compat_dt,
diff --git a/arch/arm/mach-shmobile/include/mach/common.h b/arch/arm/mach-shmobile/include/mach/common.h
index 3088f6b..2ef69cd 100644
--- a/arch/arm/mach-shmobile/include/mach/common.h
+++ b/arch/arm/mach-shmobile/include/mach/common.h
@@ -49,6 +49,7 @@ extern void r8a7740_reserve_memory(void);
 extern void r8a7740_pinmux_init(void);
 
 extern void r8a7778_meram_workaround(void);
+extern void r8a7778_reserve_memory(void);
 
 extern void r8a7779_init_irq(void);
 extern void r8a7779_init_irq_extpin(int irlm);
diff --git a/arch/arm/mach-shmobile/include/mach/r8a7778.h b/arch/arm/mach-shmobile/include/mach/r8a7778.h
index a81c987..e2816f9 100644
--- a/arch/arm/mach-shmobile/include/mach/r8a7778.h
+++ b/arch/arm/mach-shmobile/include/mach/r8a7778.h
@@ -44,6 +44,7 @@ extern void r8a7778_add_gp2d_device(void);
 extern void r8a7778_add_ipmmu_device(struct uio_info *info);
 extern void r8a7778_add_vpc_device(struct uio_info *info);
 extern void r8a7778_add_meram_device(struct uio_info *info);
+extern void r8a7778_add_vio_device(void);
 
 
 extern void r8a7778_init_late(void);
diff --git a/arch/arm/mach-shmobile/setup-r8a7778.c b/arch/arm/mach-shmobile/setup-r8a7778.c
index fa6d6cb..9370278 100644
--- a/arch/arm/mach-shmobile/setup-r8a7778.c
+++ b/arch/arm/mach-shmobile/setup-r8a7778.c
@@ -26,6 +26,7 @@
 #include <linux/of_platform.h>
 #include <linux/platform_data/gpio-rcar.h>
 #include <linux/platform_data/irq-renesas-intc-irqpin.h>
+#include <linux/platform_data/uio_dmem_genirq.h>
 #include <linux/platform_device.h>
 #include <linux/irqchip.h>
 #include <linux/serial_sci.h>
@@ -37,6 +38,7 @@
 #include <linux/usb/ehci_pdriver.h>
 #include <linux/usb/ohci_pdriver.h>
 #include <linux/dma-mapping.h>
+#include <linux/dma-contiguous.h>
 #include <linux/uio_driver.h>
 #include <mach/irqs.h>
 #include <mach/r8a7778.h>
@@ -490,6 +492,41 @@ void __init r8a7778_add_meram_device(struct uio_info *info)
 	platform_device_register_full(&pdevinfo);
 }
 
+/* VIO6C */
+static unsigned int vio_regions[] = {
+	(8 << 20),
+};
+
+static struct uio_dmem_genirq_pdata vio_platform_data = {
+	.uioinfo = {
+		.name		= "VIO6C",
+		.version	= "0",
+		.irq		= gic_iid(0x9B),
+	},
+	.dynamic_region_sizes	= vio_regions,
+	.num_dynamic_regions	= ARRAY_SIZE(vio_regions),
+};
+
+static struct resource vio_resources[] __initdata = {
+	DEFINE_RES_MEM(0xfd020000, 0x2a30),
+};
+
+static struct platform_device vio_device = {
+	.name		= "uio_dmem_genirq",
+	.id		= 0,
+	.dev = {
+		.platform_data		= &vio_platform_data,
+		.coherent_dma_mask	= ~0,
+	},
+	.resource	= vio_resources,
+	.num_resources	= ARRAY_SIZE(vio_resources),
+};
+
+void __init r8a7778_add_vio_device(void)
+{
+	platform_device_register(&vio_device);
+}
+
 void __init r8a7778_add_standard_devices(void)
 {
 	int i;
@@ -605,6 +642,11 @@ static void __init r8a7778_earlytimer_init(void)
 	shmobile_earlytimer_init();
 }
 
+void __init r8a7778_reserve_memory(void)
+{
+	dma_declare_contiguous(&vio_device.dev, 8 << 20, 0, 0);
+}
+
 static struct platform_device sh_tmu0_device = {
 	.name		= "sh_tmu",
 	.id		= 0,
-- 
1.8.2

