From 39ab8afebd42ab0e7eee03d29bb16c169330948b Mon Sep 17 00:00:00 2001
From: Kazunori Kobayashi <kkobayas@igel.co.jp>
Date: Mon, 15 Apr 2013 12:12:07 +0900
Subject: [PATCH 06/17] ARM: shmobile: r8a7778: add ICB MERAM work-around

r8a7778 chip has errata that causes an incorrect read access
from VPU5HD2 to ICB. This change is workaround against this issue.

The workaround has to access non-MERAM register address, so it
can't be controlled with MERAM driver. This change adds a function
that sets the workaround to setup-r8a7778.c. It will be invoked
from board specific code.
---
 arch/arm/mach-shmobile/include/mach/common.h |    1 +
 arch/arm/mach-shmobile/setup-r8a7778.c       |   16 ++++++++++++++++
 2 files changed, 17 insertions(+)

diff --git a/arch/arm/mach-shmobile/include/mach/common.h b/arch/arm/mach-shmobile/include/mach/common.h
index 4deffce..3e1e28b 100644
--- a/arch/arm/mach-shmobile/include/mach/common.h
+++ b/arch/arm/mach-shmobile/include/mach/common.h
@@ -77,6 +77,7 @@ extern void r8a7778_add_early_devices(void);
 extern void r8a7778_add_standard_devices(void);
 extern void r8a7778_map_io(void);
 extern void r8a7778_pinmux_init(void);
+extern void r8a7778_meram_workaround(void);
 
 extern void r8a7779_init_irq(void);
 extern void r8a7779_map_io(void);
diff --git a/arch/arm/mach-shmobile/setup-r8a7778.c b/arch/arm/mach-shmobile/setup-r8a7778.c
index cbf67d9..dfec266 100644
--- a/arch/arm/mach-shmobile/setup-r8a7778.c
+++ b/arch/arm/mach-shmobile/setup-r8a7778.c
@@ -457,3 +457,19 @@ void __init r8a7778_add_early_devices(void)
 	/* override timer setup with soc-specific code */
 	shmobile_timer.init = r8a7778_earlytimer_init;
 }
+
+/*
+ * r8a7778 chip has lasting errata on MERAM buffer.
+ * this is work-around for it.
+ */
+#define MEPRICNT	0xfd0500ac
+void r8a7778_meram_workaround(void)
+{
+	void __iomem *reg;
+
+	reg = ioremap_nocache(MEPRICNT, 4);
+	if (reg) {
+		iowrite32(0x0f880f0f, reg);
+		iounmap(reg);
+	}
+}
-- 
1.7.9.5

