From 753c463eb2718ae02957853dd4c6c9354de84bb7 Mon Sep 17 00:00:00 2001
From: Yusuke Goda <yusuke.goda.sx@renesas.com>
Date: Wed, 12 Jun 2013 17:42:09 +0900
Subject: [PATCH 599/611] ARM: shmobile: r8a7778: add VPU support

Signed-off-by: Yusuke Goda <yusuke.goda.sx@renesas.com>
---
 arch/arm/mach-shmobile/board-bockw.c          |  1 +
 arch/arm/mach-shmobile/include/mach/r8a7778.h |  1 +
 arch/arm/mach-shmobile/setup-r8a7778.c        | 36 +++++++++++++++++++++++++++
 3 files changed, 38 insertions(+)

diff --git a/arch/arm/mach-shmobile/board-bockw.c b/arch/arm/mach-shmobile/board-bockw.c
index 436e6d7..a7400d6 100644
--- a/arch/arm/mach-shmobile/board-bockw.c
+++ b/arch/arm/mach-shmobile/board-bockw.c
@@ -494,6 +494,7 @@ static void __init bockw_init(void)
 	r8a7778_add_vpc_device(&vpc_plat);
 	r8a7778_add_meram_device(&meram_plat);
 	r8a7778_add_vio_device();
+	r8a7778_add_vpu_device();
 	platform_device_register_data(&platform_bus, "soc-camera-pdrv", 0,
 				      &iclink0_ml86v7667,
 				      sizeof(iclink0_ml86v7667));
diff --git a/arch/arm/mach-shmobile/include/mach/r8a7778.h b/arch/arm/mach-shmobile/include/mach/r8a7778.h
index e2816f9..1b61885 100644
--- a/arch/arm/mach-shmobile/include/mach/r8a7778.h
+++ b/arch/arm/mach-shmobile/include/mach/r8a7778.h
@@ -45,6 +45,7 @@ extern void r8a7778_add_ipmmu_device(struct uio_info *info);
 extern void r8a7778_add_vpc_device(struct uio_info *info);
 extern void r8a7778_add_meram_device(struct uio_info *info);
 extern void r8a7778_add_vio_device(void);
+extern void r8a7778_add_vpu_device(void);
 
 
 extern void r8a7778_init_late(void);
diff --git a/arch/arm/mach-shmobile/setup-r8a7778.c b/arch/arm/mach-shmobile/setup-r8a7778.c
index 9370278..01ec939 100644
--- a/arch/arm/mach-shmobile/setup-r8a7778.c
+++ b/arch/arm/mach-shmobile/setup-r8a7778.c
@@ -527,6 +527,41 @@ void __init r8a7778_add_vio_device(void)
 	platform_device_register(&vio_device);
 }
 
+/* VPU5HD */
+static unsigned int vpu_regions[] = {
+	(105 << 20),
+};
+
+static struct uio_dmem_genirq_pdata vpu_platform_data = {
+	.uioinfo = {
+		.name		= "VPU5HD2",
+		.version	= "0",
+		.irq		= gic_iid(0x99),
+	},
+	.dynamic_region_sizes	= vpu_regions,
+	.num_dynamic_regions	= ARRAY_SIZE(vpu_regions),
+};
+
+static struct resource vpu_resources[] __initdata = {
+	DEFINE_RES_MEM(0xfd000000, 0x158),
+};
+
+static struct platform_device vpu_device = {
+	.name		= "uio_dmem_genirq",
+	.id		= 1,
+	.dev = {
+		.platform_data		= &vpu_platform_data,
+		.coherent_dma_mask	= ~0,
+	},
+	.resource	= vpu_resources,
+	.num_resources	= ARRAY_SIZE(vpu_resources),
+};
+
+void __init r8a7778_add_vpu_device(void)
+{
+	platform_device_register(&vpu_device);
+}
+
 void __init r8a7778_add_standard_devices(void)
 {
 	int i;
@@ -645,6 +680,7 @@ static void __init r8a7778_earlytimer_init(void)
 void __init r8a7778_reserve_memory(void)
 {
 	dma_declare_contiguous(&vio_device.dev, 8 << 20, 0, 0);
+	dma_declare_contiguous(&vpu_device.dev, 105 << 20, 0, 0);
 }
 
 static struct platform_device sh_tmu0_device = {
-- 
1.8.2

