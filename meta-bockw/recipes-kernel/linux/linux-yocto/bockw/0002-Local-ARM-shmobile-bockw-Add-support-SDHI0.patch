From 10d35d7ccdcb4df5d0c3cfba3576c07cddcf6388 Mon Sep 17 00:00:00 2001
From: Yusuke Goda <yusuke.goda.sx@renesas.com>
Date: Fri, 29 Mar 2013 10:27:08 +0900
Subject: [PATCH 2/3] Local: ARM: shmobile: bockw: Add support SDHI0

Signed-off-by: Yusuke Goda <yusuke.goda.sx@renesas.com>
---
 arch/arm/mach-shmobile/board-bockw.c   | 47 ++++++++++++++++++++++++++++++++++
 arch/arm/mach-shmobile/clock-r8a7778.c |  6 +++--
 arch/arm/mach-shmobile/setup-r8a7778.c |  7 +++++
 3 files changed, 58 insertions(+), 2 deletions(-)

diff --git a/arch/arm/mach-shmobile/board-bockw.c b/arch/arm/mach-shmobile/board-bockw.c
index 1c90730..5422609 100644
--- a/arch/arm/mach-shmobile/board-bockw.c
+++ b/arch/arm/mach-shmobile/board-bockw.c
@@ -28,6 +28,9 @@
 #include <linux/mtd/mtd.h>
 #include <linux/mtd/partitions.h>
 #include <linux/mtd/physmap.h>
+#include <linux/mfd/tmio.h>
+#include <linux/mmc/host.h>
+#include <linux/mmc/sh_mobile_sdhi.h>
 #include <mach/irqs.h>
 #include <mach/common.h>
 #include <mach/r8a7778.h>
@@ -179,15 +182,48 @@ static struct platform_device nor_flash_device = {
 	.resource	= nor_flash_resources,
 };
 
+static struct sh_mobile_sdhi_info sdhi0_info = {
+	.tmio_caps	= MMC_CAP_SD_HIGHSPEED,
+	.tmio_ocr_mask	= MMC_VDD_165_195 | MMC_VDD_32_33 | MMC_VDD_33_34,
+	.tmio_flags	= TMIO_MMC_HAS_IDLE_WAIT,
+};
+
+static struct resource sdhi0_resources[] = {
+	[0] = {
+		.name	= "SDHI0",
+		.start	= 0xffe4c000,
+		.end	= 0xffe4c0ff,
+		.flags	= IORESOURCE_MEM,
+	},
+	/*
+	 * no SH_MOBILE_SDHI_IRQ_CARD_DETECT here
+	 */
+	[1] = {
+		.start	= gic_iid(0x77),
+		.flags	= IORESOURCE_IRQ,
+	},
+};
+
+static struct platform_device sdhi0_device = {
+	.name		= "sh_mobile_sdhi",
+	.id		= 0,
+	.dev		= {
+		.platform_data	= &sdhi0_info,
+	},
+	.num_resources	= ARRAY_SIZE(sdhi0_resources),
+	.resource	= sdhi0_resources,
+};
 
 static struct platform_device *bockw_devices[] __initdata = {
 	&smsc911x_device,
 	&rcar_du_device,
 	&rcar_gp2d_device,
 	&nor_flash_device,
+	&sdhi0_device,
 };
 
 #define IRQ0MR		FPGA(0x18200030)
+#define PUPR4		IOMEM(0xfffc0110)
 static void __init bockw_init(void)
 {
 	u16 val;
@@ -238,6 +274,17 @@ static void __init bockw_init(void)
 	gpio_request(GPIO_FN_DU0_DOTCLKO_UT1, NULL);
 	gpio_request(GPIO_FN_DU0_DISP, NULL);
 
+	/* SDHI0 */
+	gpio_request(GPIO_FN_SD0_CLK, NULL);
+	gpio_request(GPIO_FN_SD0_CMD, NULL);
+	gpio_request(GPIO_FN_SD0_DAT0, NULL);
+	gpio_request(GPIO_FN_SD0_DAT1, NULL);
+	gpio_request(GPIO_FN_SD0_DAT2, NULL);
+	gpio_request(GPIO_FN_SD0_DAT3, NULL);
+	gpio_request(GPIO_FN_SD0_CD, NULL);
+	gpio_request(GPIO_FN_SD0_WP, NULL);
+	__raw_writel(__raw_readl(PUPR4) | (3 << 26), PUPR4);
+
 	r8a7778_add_standard_devices();
 	platform_add_devices(bockw_devices, ARRAY_SIZE(bockw_devices));
 }
diff --git a/arch/arm/mach-shmobile/clock-r8a7778.c b/arch/arm/mach-shmobile/clock-r8a7778.c
index 504f11b..34e2495 100644
--- a/arch/arm/mach-shmobile/clock-r8a7778.c
+++ b/arch/arm/mach-shmobile/clock-r8a7778.c
@@ -104,11 +104,12 @@ static struct clk div4_clks[DIV4_NR] = {
 				      0x0300, CLK_ENABLE_ON_INIT),
 };
 
-enum { MSTP107, MSTP103, MSTP026, MSTP025, MSTP024, MSTP023, MSTP022, MSTP021,
-	MSTP016, MSTP015, MSTP014,
+enum { MSTP323, MSTP107, MSTP103, MSTP026, MSTP025, MSTP024, MSTP023, MSTP022,
+	MSTP021, MSTP016, MSTP015, MSTP014,
 	MSTP_NR };
 
 static struct clk mstp_clks[MSTP_NR] = {
+	[MSTP323] = SH_CLK_MSTP32(&div4_clks[DIV4_P], MSTPCR3, 23, 0), /* SDHI0 */
 	[MSTP107] = SH_CLK_MSTP32(&div4_clks[DIV4_P], MSTPCR1,  7, 0), /* GP2D */
 	[MSTP103] = SH_CLK_MSTP32(&div4_clks[DIV4_S], MSTPCR1,  3, 0), /* DU */
 	[MSTP026] = SH_CLK_MSTP32(&div4_clks[DIV4_P], MSTPCR0, 26, 0), /* SCIF0 */
@@ -136,6 +137,7 @@ static struct clk_lookup lookups[] = {
 	CLKDEV_CON_ID("peripheral_clk",	&div4_clks[DIV4_P]),
 
 	/* MSTP32 clocks */
+	CLKDEV_DEV_ID("sh_mobile_sdhi.0",	&mstp_clks[MSTP323]), /* SDHI0 */
 	CLKDEV_DEV_ID("gp2d",		&mstp_clks[MSTP107]), /* GP2D */
 	CLKDEV_DEV_ID("rcar-du.0",	&mstp_clks[MSTP103]), /* DU */
 	CLKDEV_DEV_ID("sh_tmu.0",	&mstp_clks[MSTP016]), /* TMU00 */
diff --git a/arch/arm/mach-shmobile/setup-r8a7778.c b/arch/arm/mach-shmobile/setup-r8a7778.c
index 61aa4a7..eaa1722 100644
--- a/arch/arm/mach-shmobile/setup-r8a7778.c
+++ b/arch/arm/mach-shmobile/setup-r8a7778.c
@@ -58,6 +58,13 @@ static struct map_desc r8a7778_io_desc[] __initdata = {
 		.length		= SZ_16M,
 		.type		= MT_DEVICE_NONSHARED
 	},
+	/* 1M entity map for 0xfffcxxxx (GPIO) */
+	{
+		.virtual	= 0xfffc0000,
+		.pfn		= __phys_to_pfn(0xfffc0000),
+		.length		= SZ_256,
+		.type		= MT_DEVICE_NONSHARED
+	},
 };
 
 void __init r8a7778_map_io(void)
-- 
1.8.2

