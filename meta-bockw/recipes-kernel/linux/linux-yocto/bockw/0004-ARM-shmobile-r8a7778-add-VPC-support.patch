From 6b8ca38774005f1afa356c8e4fcb4b424a19d4aa Mon Sep 17 00:00:00 2001
From: Kazunori Kobayashi <kkobayas@igel.co.jp>
Date: Mon, 15 Apr 2013 15:02:25 +0900
Subject: [PATCH 04/17] ARM: shmobile: r8a7778: add VPC support

---
 arch/arm/mach-shmobile/clock-r8a7778.c |    4 +++-
 arch/arm/mach-shmobile/setup-r8a7778.c |   27 +++++++++++++++++++++++++++
 2 files changed, 30 insertions(+), 1 deletion(-)

diff --git a/arch/arm/mach-shmobile/clock-r8a7778.c b/arch/arm/mach-shmobile/clock-r8a7778.c
index b05960f..5d2c212 100644
--- a/arch/arm/mach-shmobile/clock-r8a7778.c
+++ b/arch/arm/mach-shmobile/clock-r8a7778.c
@@ -104,7 +104,7 @@ static struct clk div4_clks[DIV4_NR] = {
 				      0x0300, CLK_ENABLE_ON_INIT),
 };
 
-enum { MSTP410,
+enum { MSTP410, MSTP408,
 	MSTP323, MSTP107, MSTP103, MSTP100,
 	MSTP030,
 	MSTP029, MSTP028, MSTP027, MSTP026, MSTP025, MSTP024, MSTP023, MSTP022, MSTP021,
@@ -114,6 +114,7 @@ enum { MSTP410,
 
 static struct clk mstp_clks[MSTP_NR] = {
 	[MSTP410] = SH_CLK_MSTP32(&div4_clks[DIV4_S3], MSTPCR4, 10, 0), /* ICB */
+	[MSTP408] = SH_CLK_MSTP32(&div4_clks[DIV4_S3], MSTPCR4,  8, 0), /* VPC */
 	[MSTP323] = SH_CLK_MSTP32(&div4_clks[DIV4_P], MSTPCR3, 23, 0), /* SDHI0 */
 	[MSTP107] = SH_CLK_MSTP32(&div4_clks[DIV4_P], MSTPCR1,  7, 0), /* GP2D */
 	[MSTP103] = SH_CLK_MSTP32(&div4_clks[DIV4_S], MSTPCR1,  3, 0), /* DU */
@@ -149,6 +150,7 @@ static struct clk_lookup lookups[] = {
 
 	/* MSTP32 clocks */
 	CLKDEV_CON_ID("icb",		&mstp_clks[MSTP410]), /* ICB */
+	CLKDEV_DEV_ID("uio_pdrv_genirq.1",	&mstp_clks[MSTP408]), /* VPC */
 	CLKDEV_DEV_ID("sh_mobile_sdhi.0",	&mstp_clks[MSTP323]), /* SDHI0 */
 	CLKDEV_DEV_ID("gp2d",		&mstp_clks[MSTP107]), /* GP2D */
 	CLKDEV_DEV_ID("rcar-du.0",	&mstp_clks[MSTP103]), /* DU */
diff --git a/arch/arm/mach-shmobile/setup-r8a7778.c b/arch/arm/mach-shmobile/setup-r8a7778.c
index 1515f41..c8c4f4b 100644
--- a/arch/arm/mach-shmobile/setup-r8a7778.c
+++ b/arch/arm/mach-shmobile/setup-r8a7778.c
@@ -335,6 +335,32 @@ static struct platform_device ipmmu_device = {
 	.num_resources  = ARRAY_SIZE(ipmmu_resources),
 };
 
+/* VPC */
+static struct uio_info vpc_platform_data = {
+	.name = "VPC",
+	.version = "0",
+	.irq = -1,
+};
+
+static struct resource vpc_resources[] = {
+	[0] = {
+		.name   = "VPC",
+		.start  = 0xfd0d0000,
+		.end    = 0xfd0d008f,
+		.flags  = IORESOURCE_MEM,
+	},
+};
+
+static struct platform_device vpc_device = {
+	.name           = "uio_pdrv_genirq",
+	.id             = 1,
+	.dev = {
+		.platform_data = &vpc_platform_data,
+	},
+	.resource       = vpc_resources,
+	.num_resources  = ARRAY_SIZE(vpc_resources),
+};
+
 static struct platform_device *r8a7778_early_devices[] __initdata = {
 	&scif0_device,
 	&scif1_device,
@@ -349,6 +375,7 @@ static struct platform_device *r8a7778_early_devices[] __initdata = {
 	&i2c2_device,
 	&i2c3_device,
 	&ipmmu_device,
+	&vpc_device,
 };
 
 static struct platform_device *r8a7778_late_devices[] __initdata = {
-- 
1.7.9.5

