From 24aeb3f5e8e41ce16efca21b12f6e48a266919af Mon Sep 17 00:00:00 2001
From: Kuninori Morimoto <kuninori.morimoto.gx@renesas.com>
Date: Fri, 22 Feb 2013 09:41:18 +0900
Subject: [PATCH 6/7] Local: ARM: shmobile: bockw: add SMSC Eth support

Signed-off-by: Kuninori Morimoto <kuninori.morimoto.gx@renesas.com>
---
 arch/arm/configs/bockw_defconfig     |   34 ++++++++++++++--
 arch/arm/mach-shmobile/board-bockw.c |   71 +++++++++++++++++++++++++++++++++-
 2 files changed, 101 insertions(+), 4 deletions(-)

diff --git a/arch/arm/configs/bockw_defconfig b/arch/arm/configs/bockw_defconfig
index c358481..d92384c 100644
--- a/arch/arm/configs/bockw_defconfig
+++ b/arch/arm/configs/bockw_defconfig
@@ -4,8 +4,6 @@ CONFIG_KERNEL_LZMA=y
 CONFIG_IKCONFIG=y
 CONFIG_IKCONFIG_PROC=y
 CONFIG_LOG_BUF_SHIFT=16
-CONFIG_BLK_DEV_INITRD=y
-CONFIG_INITRAMFS_SOURCE="/tftpboot/initramfs-arm/"
 CONFIG_SYSCTL_SYSCALL=y
 CONFIG_EMBEDDED=y
 CONFIG_SLAB=y
@@ -29,16 +27,42 @@ CONFIG_AEABI=y
 CONFIG_HIGHMEM=y
 CONFIG_ZBOOT_ROM_TEXT=0x0
 CONFIG_ZBOOT_ROM_BSS=0x0
-CONFIG_CMDLINE="console=ttySC0,115200 earlyprintk=sh-sci.0,115200 ignore_loglevel root=/dev/nfs ip=on"
+CONFIG_CMDLINE="console=ttySC0,115200 earlyprintk=sh-sci.0,115200 ignore_loglevel root=/dev/nfs ip=dhcp"
 CONFIG_CMDLINE_FORCE=y
 # CONFIG_CORE_DUMP_DEFAULT_ELF_HEADERS is not set
 # CONFIG_SUSPEND is not set
+CONFIG_NET=y
+CONFIG_PACKET=y
+CONFIG_UNIX=y
+CONFIG_INET=y
+CONFIG_IP_PNP=y
+CONFIG_IP_PNP_DHCP=y
+# CONFIG_INET_XFRM_MODE_TRANSPORT is not set
+# CONFIG_INET_XFRM_MODE_TUNNEL is not set
+# CONFIG_INET_XFRM_MODE_BEET is not set
+# CONFIG_INET_LRO is not set
+# CONFIG_INET_DIAG is not set
+# CONFIG_IPV6 is not set
+# CONFIG_WIRELESS is not set
 CONFIG_UEVENT_HELPER_PATH="/sbin/hotplug"
 CONFIG_DEVTMPFS=y
 CONFIG_DEVTMPFS_MOUNT=y
 # CONFIG_STANDALONE is not set
 # CONFIG_PREVENT_FIRMWARE_BUILD is not set
 # CONFIG_FW_LOADER is not set
+CONFIG_NETDEVICES=y
+# CONFIG_NET_VENDOR_BROADCOM is not set
+# CONFIG_NET_VENDOR_CHELSIO is not set
+# CONFIG_NET_VENDOR_CIRRUS is not set
+# CONFIG_NET_VENDOR_FARADAY is not set
+# CONFIG_NET_VENDOR_INTEL is not set
+# CONFIG_NET_VENDOR_MARVELL is not set
+# CONFIG_NET_VENDOR_MICREL is not set
+# CONFIG_NET_VENDOR_NATSEMI is not set
+# CONFIG_NET_VENDOR_SEEQ is not set
+CONFIG_SMSC911X=y
+# CONFIG_NET_VENDOR_STMICRO is not set
+# CONFIG_WLAN is not set
 # CONFIG_INPUT is not set
 # CONFIG_SERIO is not set
 # CONFIG_VT is not set
@@ -58,6 +82,10 @@ CONFIG_UIO_PDRV_GENIRQ=y
 # CONFIG_INOTIFY_USER is not set
 CONFIG_TMPFS=y
 # CONFIG_MISC_FILESYSTEMS is not set
+CONFIG_NFS_FS=y
+CONFIG_NFS_V3=y
+CONFIG_NFS_V4=y
+CONFIG_ROOT_NFS=y
 # CONFIG_ENABLE_WARN_DEPRECATED is not set
 # CONFIG_ENABLE_MUST_CHECK is not set
 # CONFIG_SCHED_DEBUG is not set
diff --git a/arch/arm/mach-shmobile/board-bockw.c b/arch/arm/mach-shmobile/board-bockw.c
index d067622..9bd4850 100644
--- a/arch/arm/mach-shmobile/board-bockw.c
+++ b/arch/arm/mach-shmobile/board-bockw.c
@@ -22,22 +22,91 @@
 #include <linux/init.h>
 #include <linux/irq.h>
 #include <linux/platform_device.h>
+#include <linux/smsc911x.h>
+#include <mach/irqs.h>
 #include <mach/common.h>
 #include <asm/mach-types.h>
 #include <asm/mach/arch.h>
+#include <asm/mach/map.h>
 #include <asm/hardware/gic.h>
 
+/* FPGA is mapped to 0xe0000000 */
+#define FPGA(x) (((x) & 0x0FFFFFFF) + 0xe0000000)
+
+static struct map_desc bockw_io_desc[] __initdata = {
+	/* FPGA / AREA0 from 0x18200000 */
+	{
+		.virtual	= FPGA(0x18200000),
+		.pfn		= __phys_to_pfn(0x18200000),
+		.length		= SZ_1M,
+		.type		= MT_DEVICE_NONSHARED
+	},
+};
+
+static void __init bockw_map_io(void)
+{
+	iotable_init(bockw_io_desc, ARRAY_SIZE(bockw_io_desc));
+
+	r8a7778_map_io();
+}
+
+static struct smsc911x_platform_config bockw_smsc911x_config = {
+	.irq_polarity	= SMSC911X_IRQ_POLARITY_ACTIVE_LOW,
+	.irq_type	= SMSC911X_IRQ_TYPE_PUSH_PULL,
+	.flags		= SMSC911X_USE_32BIT,
+	.phy_interface	= PHY_INTERFACE_MODE_MII,
+};
+
+static struct resource bockw_smsc911x_resources[] = {
+	{
+		.start	= 0x18300000,
+		.end	= 0x18301000 - 1,
+		.flags	= IORESOURCE_MEM,
+	},
+	{
+		.start	= gic_iid(0x3B), /* IRQ 0 */
+		.flags	= IORESOURCE_IRQ,
+	},
+};
+
+static struct platform_device smsc911x_device = {
+	.name		= "smsc911x",
+	.id		= 0,
+	.dev		= {
+		.platform_data	= &bockw_smsc911x_config,
+	},
+	.num_resources	= ARRAY_SIZE(bockw_smsc911x_resources),
+	.resource	= bockw_smsc911x_resources,
+};
+
 static struct platform_device *bockw_devices[] __initdata = {
+	&smsc911x_device,
 };
 
+#define IRQ0MR		FPGA(0x18200030)
 static void __init bockw_init(void)
 {
+	u16 val;
+
+	/*
+	 * CAUTION
+	 *
+	 * IRQ0/1 is cascaded interrupt from FPGA.
+	 * it should be cared in the future
+	 * Now, it is assuming IRQ0 was used only from SMSC.
+	 */
+
+	/* interrupt mask on IRQ0 */
+	val = ioread16(IRQ0MR);
+	val &= ~(1 << 4); /* enable SMSC911x */
+	iowrite16(val, IRQ0MR);
+
 	r8a7778_add_standard_devices();
 	platform_add_devices(bockw_devices, ARRAY_SIZE(bockw_devices));
 }
 
 MACHINE_START(BOCKW, "bockw")
-	.map_io		= r8a7778_map_io,
+	.map_io		= bockw_map_io,
 	.init_early	= r8a7778_add_early_devices,
 	.nr_irqs	= NR_IRQS_LEGACY,
 	.init_irq	= r8a7778_init_irq,
-- 
1.7.9.5

