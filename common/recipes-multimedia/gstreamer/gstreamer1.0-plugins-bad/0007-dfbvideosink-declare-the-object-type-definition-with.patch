From e62e579b446d27fe60741d0591059cfc8e92813a Mon Sep 17 00:00:00 2001
From: Kazunori Kobayashi <kkobayas@igel.co.jp>
Date: Wed, 26 Jun 2013 11:51:29 +0900
Subject: [PATCH 07/21] dfbvideosink: declare the object type definition with
 G_DEFINE_TYPE_WITH_CODE

---
 ext/directfb/dfbvideosink.c | 104 +++++++-------------------------------------
 1 file changed, 16 insertions(+), 88 deletions(-)

diff --git a/ext/directfb/dfbvideosink.c b/ext/directfb/dfbvideosink.c
index 97d4def..350f4b2 100644
--- a/ext/directfb/dfbvideosink.c
+++ b/ext/directfb/dfbvideosink.c
@@ -129,9 +129,18 @@ static DFBSurfacePixelFormat gst_dfbvideosink_get_format_from_caps (GstCaps *
     caps);
 static void gst_dfbvideosink_update_colorbalance (GstDfbVideoSink *
     dfbvideosink);
+static void gst_dfbvideosink_navigation_init (GstNavigationInterface * iface);
+static void gst_dfbvideosink_colorbalance_init (GstColorBalanceInterface
+    * iface);
 
 static GstVideoSinkClass *parent_class = NULL;
 
+G_DEFINE_TYPE_WITH_CODE (GstDfbVideoSink, gst_dfbvideosink, GST_TYPE_VIDEO_SINK,
+    G_IMPLEMENT_INTERFACE (GST_TYPE_NAVIGATION,
+        gst_dfbvideosink_navigation_init);
+    G_IMPLEMENT_INTERFACE (GST_TYPE_COLOR_BALANCE,
+        gst_dfbvideosink_colorbalance_init));
+
 #ifndef GST_DISABLE_GST_DEBUG
 static const char *
 gst_dfbvideosink_get_format_name (DFBSurfacePixelFormat format)
@@ -1447,22 +1456,6 @@ beach:
   return ret;
 }
 
-/* Interfaces stuff */
-
-static gboolean
-gst_dfbvideosink_interface_supported (GstImplementsInterface * iface,
-    GType type)
-{
-  g_assert (type == GST_TYPE_NAVIGATION || type == GST_TYPE_COLOR_BALANCE);
-  return TRUE;
-}
-
-static void
-gst_dfbvideosink_interface_init (GstImplementsInterfaceClass * klass)
-{
-  klass->supported = gst_dfbvideosink_interface_supported;
-}
-
 static void
 gst_dfbvideosink_navigation_send_event (GstNavigation * navigation,
     GstStructure * structure)
@@ -1788,19 +1781,6 @@ gst_dfbvideosink_init (GstDfbVideoSink * dfbvideosink)
 }
 
 static void
-gst_dfbvideosink_base_init (gpointer g_class)
-{
-  GstElementClass *element_class = GST_ELEMENT_CLASS (g_class);
-
-  gst_element_class_set_static_metadata (element_class, "DirectFB video sink",
-      "Sink/Video",
-      "A DirectFB based videosink", "Julien Moutte <julien@moutte.net>");
-
-  gst_element_class_add_pad_template (element_class,
-      gst_static_pad_template_get (&gst_dfbvideosink_sink_template_factory));
-}
-
-static void
 gst_dfbvideosink_class_init (GstDfbVideoSinkClass * klass)
 {
   GObjectClass *gobject_class;
@@ -1844,6 +1824,13 @@ gst_dfbvideosink_class_init (GstDfbVideoSinkClass * klass)
           "Wait for next vertical sync to draw frames", TRUE,
           G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
 
+  gst_element_class_set_static_metadata (gstelement_class,
+      "DirectFB video sink", "Sink/Video", "A DirectFB based videosink",
+      "Julien Moutte <julien@moutte.net>");
+
+  gst_element_class_add_pad_template (gstelement_class,
+      gst_static_pad_template_get (&gst_dfbvideosink_sink_template_factory));
+
   gstelement_class->change_state = gst_dfbvideosink_change_state;
 
   gstbasesink_class->get_caps = gst_dfbvideosink_getcaps;
@@ -1853,65 +1840,6 @@ gst_dfbvideosink_class_init (GstDfbVideoSinkClass * klass)
   gstbasesink_class->render = gst_dfbvideosink_show_frame;
 }
 
-/* ============================================================= */
-/*                                                               */
-/*                       Public Methods                          */
-/*                                                               */
-/* ============================================================= */
-
-/* =========================================== */
-/*                                             */
-/*          Object typing & Creation           */
-/*                                             */
-/* =========================================== */
-
-GType
-gst_dfbvideosink_get_type (void)
-{
-  static GType dfbvideosink_type = 0;
-
-  if (!dfbvideosink_type) {
-    static const GTypeInfo dfbvideosink_info = {
-      sizeof (GstDfbVideoSinkClass),
-      gst_dfbvideosink_base_init,
-      NULL,
-      (GClassInitFunc) gst_dfbvideosink_class_init,
-      NULL,
-      NULL,
-      sizeof (GstDfbVideoSink),
-      0,
-      (GInstanceInitFunc) gst_dfbvideosink_init,
-    };
-    static const GInterfaceInfo iface_info = {
-      (GInterfaceInitFunc) gst_dfbvideosink_interface_init,
-      NULL,
-      NULL,
-    };
-    static const GInterfaceInfo navigation_info = {
-      (GInterfaceInitFunc) gst_dfbvideosink_navigation_init,
-      NULL,
-      NULL,
-    };
-    static const GInterfaceInfo colorbalance_info = {
-      (GInterfaceInitFunc) gst_dfbvideosink_colorbalance_init,
-      NULL,
-      NULL,
-    };
-
-    dfbvideosink_type = g_type_register_static (GST_TYPE_VIDEO_SINK,
-        "GstDfbVideoSink", &dfbvideosink_info, 0);
-
-    g_type_add_interface_static (dfbvideosink_type,
-        GST_TYPE_IMPLEMENTS_INTERFACE, &iface_info);
-    g_type_add_interface_static (dfbvideosink_type, GST_TYPE_NAVIGATION,
-        &navigation_info);
-    g_type_add_interface_static (dfbvideosink_type, GST_TYPE_COLOR_BALANCE,
-        &colorbalance_info);
-  }
-
-  return dfbvideosink_type;
-}
-
 static gboolean
 plugin_init (GstPlugin * plugin)
 {
-- 
1.8.1.2

