From 74a1e765a7686b94753096f183861ad0cc52792a Mon Sep 17 00:00:00 2001
From: Koji Matsuoka <koji.matsuoka.xm@renesas.com>
Date: Mon, 12 Jun 2017 19:32:09 +0900
Subject: drm: rcar-du: Fix digital RGB routing for R-Car D3

Signed-off-by: Koji Matsuoka <koji.matsuoka.xm@renesas.com>
---
 drivers/gpu/drm/rcar-du/rcar_du_drv.c   | 3 ++-
 drivers/gpu/drm/rcar-du/rcar_du_drv.h   | 1 +
 drivers/gpu/drm/rcar-du/rcar_du_group.c | 9 +++++++--
 3 files changed, 10 insertions(+), 3 deletions(-)

diff --git a/drivers/gpu/drm/rcar-du/rcar_du_drv.c b/drivers/gpu/drm/rcar-du/rcar_du_drv.c
index eb3f1c5..42f2da9 100644
--- a/drivers/gpu/drm/rcar-du/rcar_du_drv.c
+++ b/drivers/gpu/drm/rcar-du/rcar_du_drv.c
@@ -282,7 +282,8 @@
 		  | RCAR_DU_FEATURE_EXT_CTRL_REGS
 		  | RCAR_DU_FEATURE_VSP1_SOURCE
 		  | RCAR_DU_FEATURE_GEN3_REGS
-		  | RCAR_DU_FEATURE_LVDS_PLL,
+		  | RCAR_DU_FEATURE_LVDS_PLL
+		  | RCAR_DU_FEATURE_D3,
 	.num_crtcs = 2,
 	.routes = {
 		/* R8A77995 has two LVDS output and one RGB output.
diff --git a/drivers/gpu/drm/rcar-du/rcar_du_drv.h b/drivers/gpu/drm/rcar-du/rcar_du_drv.h
index 701aabd..610c0d3 100644
--- a/drivers/gpu/drm/rcar-du/rcar_du_drv.h
+++ b/drivers/gpu/drm/rcar-du/rcar_du_drv.h
@@ -41,6 +41,7 @@
 #define RCAR_DU_FEATURE_DIDSR2_REG	(1 << 4)	/* Has DIDSR2 register */
 #define RCAR_DU_FEATURE_VSPDL_SOURCE	(1 << 5)	/* Has VSPDL from VSP2 */
 #define RCAR_DU_FEATURE_LVDS_PLL	(1 << 6)	/* Use PLL in LVDS */
+#define RCAR_DU_FEATURE_D3		(1 << 7)	/* Use R-Car D3 */
 
 #define RCAR_DU_QUIRK_ALIGN_128B	(1 << 0)	/* Align pitches to 128 bytes */
 #define RCAR_DU_QUIRK_LVDS_LANES	(1 << 1)	/* LVDS lanes 1 and 3 inverted */
diff --git a/drivers/gpu/drm/rcar-du/rcar_du_group.c b/drivers/gpu/drm/rcar-du/rcar_du_group.c
index ed496a8..5933791 100644
--- a/drivers/gpu/drm/rcar-du/rcar_du_group.c
+++ b/drivers/gpu/drm/rcar-du/rcar_du_group.c
@@ -80,11 +80,16 @@ static void rcar_du_group_setup_defr8(struct rcar_du_group *rgrp)
 		 */
 		u32 crtc = ffs(possible_crtcs) - 1;
 
-		if (rgrp->index == 0)
+		if ((rgrp->index == 0) &&
+			(!rcar_du_has(rcdu, RCAR_DU_FEATURE_D3)))
 			return;
 
-		if (crtc / 2 == rgrp->index)
+		if (rcar_du_has(rcdu, RCAR_DU_FEATURE_D3) &&
+			(possible_crtcs > 1))
+			defr8 |= DEFR8_DRGBS_DU(rcdu->dpad0_source);
+		else if (crtc / 2 == rgrp->index)
 			defr8 |= DEFR8_DRGBS_DU(crtc);
+
 	}
 
 	rcar_du_group_write(rgrp, DEFR8, defr8);
-- 
1.9.1

