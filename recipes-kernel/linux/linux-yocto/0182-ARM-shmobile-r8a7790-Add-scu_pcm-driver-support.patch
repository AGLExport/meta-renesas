From d4cea2342a9148f3d385a06b966de692d8758ab4 Mon Sep 17 00:00:00 2001
From: Shunsuke Kataoka <shunsuke.kataoka.df@renesas.com>
Date: Thu, 11 Apr 2013 14:04:14 +0900
Subject: ARM: shmobile: r8a7790: Add scu_pcm driver support

Signed-off-by: Kouei Abe <kouei.abe.cp@renesas.com>
---
 arch/arm/configs/lager_defconfig              |    6 +++
 arch/arm/mach-shmobile/board-lager.c          |   57 +++++++++++++++++++++++++
 arch/arm/mach-shmobile/clock-r8a7790.c        |    2 +-
 arch/arm/mach-shmobile/include/mach/r8a7790.h |   11 +++++
 arch/arm/mach-shmobile/setup-r8a7790.c        |   26 +++++++++++
 5 files changed, 101 insertions(+), 1 deletion(-)

diff --git a/arch/arm/configs/lager_defconfig b/arch/arm/configs/lager_defconfig
index e12d57a..f430744 100644
--- a/arch/arm/configs/lager_defconfig
+++ b/arch/arm/configs/lager_defconfig
@@ -1,6 +1,7 @@
 # CONFIG_ARM_PATCH_PHYS_VIRT is not set
 CONFIG_EXPERIMENTAL=y
 CONFIG_KERNEL_LZMA=y
+CONFIG_SYSVIPC=y
 CONFIG_IKCONFIG=y
 CONFIG_IKCONFIG_PROC=y
 CONFIG_LOG_BUF_SHIFT=16
@@ -83,6 +84,11 @@ CONFIG_DRM=y
 CONFIG_DRM_RCAR_DU=y
 CONFIG_FRAMEBUFFER_CONSOLE=y
 CONFIG_LOGO=y
+CONFIG_SOUND=y
+CONFIG_SND=y
+CONFIG_SND_SOC=y
+CONFIG_SND_SOC_SCU=y
+CONFIG_SND_SCU_LAGER=y
 CONFIG_HID_SUPPORT=y
 CONFIG_USB_SUPPORT=y
 CONFIG_USB=y
diff --git a/arch/arm/mach-shmobile/board-lager.c b/arch/arm/mach-shmobile/board-lager.c
index 4cdd079..1d84c9d 100644
--- a/arch/arm/mach-shmobile/board-lager.c
+++ b/arch/arm/mach-shmobile/board-lager.c
@@ -28,6 +28,7 @@
 #include <linux/err.h>
 #include <linux/usb/ehci_pdriver.h>
 #include <linux/usb/ohci_pdriver.h>
+#include <linux/i2c.h>
 #include <mach/r8a7790.h>
 #include <mach/common.h>
 #include <mach/irqs.h>
@@ -38,6 +39,49 @@
 #include <asm/arch_timer.h>
 #include <asm/hardware/gic.h>
 
+static struct i2c_board_info lager_i2c_devices[] = {
+	{ I2C_BOARD_INFO("ak4642", 0x12), },
+};
+
+static struct platform_device alsa_soc_platform_device = {
+	.name		= "lager_alsa_soc_platform",
+	.id		= 0,
+};
+
+static struct resource scu_resources[] = {
+	[0] = {
+		.name   = "scu",
+		.start  = 0xec000000,
+		.end    = 0xec500fff,
+		.flags  = IORESOURCE_MEM,
+	},
+	[1] = {
+		.name   = "ssiu",
+		.start  = 0xec540000,
+		.end    = 0xec54085f,
+		.flags  = IORESOURCE_MEM,
+	},
+	[2] = {
+		.name   = "ssi",
+		.start  = 0xec541000,
+		.end    = 0xec54127f,
+		.flags  = IORESOURCE_MEM,
+	},
+	[3] = {
+		.name   = "adg",
+		.start  = 0xec5a0000,
+		.end    = 0xec5a0067,
+		.flags  = IORESOURCE_MEM,
+	},
+};
+
+static struct platform_device scu_device = {
+	.name		= "scu-pcm-audio",
+	.id		= 0,
+	.num_resources	= ARRAY_SIZE(scu_resources),
+	.resource	= scu_resources,
+};
+
 static u64 usb_dmamask = ~(u32)0;
 
 struct usb_ehci_pdata ehci_pdata = {
@@ -195,6 +239,8 @@ struct platform_device ohci2_device = {
 };
 
 static struct platform_device *lager_devices[] __initdata = {
+	&alsa_soc_platform_device,
+	&scu_device,
 	&ehci0_device,
 	&ohci0_device,
 	&ehci1_device,
@@ -436,6 +482,15 @@ static void __init lager_init(void)
 	gpio_request(GPIO_FN_DU2_CDE, NULL);
 	gpio_request(GPIO_FN_DU2_EXODDF_DU2_ODDF_DISP_CDE, NULL);
 
+	/* SSI */
+	gpio_request(GPIO_FN_SSI_SCK0129, NULL);
+	gpio_request(GPIO_FN_SSI_WS0129, NULL);
+	gpio_request(GPIO_FN_SSI_SDATA0, NULL);
+	gpio_request(GPIO_FN_SSI_SDATA1, NULL);
+
+	/* Audio Clock */
+	gpio_request(GPIO_FN_AUDIO_CLKA, NULL);
+
 	/* USB Host */
 	gpio_request(GPIO_FN_USB0_PWEN, NULL);
 	gpio_request(GPIO_FN_USB0_OVC_VBUS, NULL);
@@ -448,6 +503,8 @@ static void __init lager_init(void)
 
 	r8a7790_add_standard_devices();
 	platform_add_devices(lager_devices, ARRAY_SIZE(lager_devices));
+	i2c_register_board_info(2, lager_i2c_devices,
+				ARRAY_SIZE(lager_i2c_devices));
 }
 
 static void __init lager_timer_init(void)
diff --git a/arch/arm/mach-shmobile/clock-r8a7790.c b/arch/arm/mach-shmobile/clock-r8a7790.c
index 60b48aa..92ba7a7 100644
--- a/arch/arm/mach-shmobile/clock-r8a7790.c
+++ b/arch/arm/mach-shmobile/clock-r8a7790.c
@@ -193,7 +193,7 @@ static struct clk_lookup lookups[] = {
 	CLKDEV_DEV_ID("src1", &mstp_clks[MSTP1030]),
 	CLKDEV_DEV_ID("dvc0", &mstp_clks[MSTP1019]),
 	CLKDEV_DEV_ID("dvc1", &mstp_clks[MSTP1018]),
-	CLKDEV_DEV_ID("scu", &mstp_clks[MSTP1017]),
+	CLKDEV_DEV_ID("scu-pcm-audio.0", &mstp_clks[MSTP1017]),
 	CLKDEV_DEV_ID("ssi0", &mstp_clks[MSTP1015]),
 	CLKDEV_DEV_ID("ssi1", &mstp_clks[MSTP1014]),
 	CLKDEV_DEV_ID("ssi", &mstp_clks[MSTP1005]),
diff --git a/arch/arm/mach-shmobile/include/mach/r8a7790.h b/arch/arm/mach-shmobile/include/mach/r8a7790.h
index 426f547..f4be68b 100644
--- a/arch/arm/mach-shmobile/include/mach/r8a7790.h
+++ b/arch/arm/mach-shmobile/include/mach/r8a7790.h
@@ -565,4 +565,15 @@ enum {
 	SHDMA_DEVID_AUDIOPP,
 };
 
+/* DMA slave IDs */
+enum {
+	SHDMA_SLAVE_INVALID,
+	SHDMA_SLAVE_MEM_SSI0,
+	SHDMA_SLAVE_MEM_SRC0,
+	SHDMA_SLAVE_SSI1_MEM,
+	SHDMA_SLAVE_SRC1_MEM,
+	SHDMA_SLAVE_SRC0_SSI0,
+	SHDMA_SLAVE_SSI1_SRC1,
+};
+
 #endif /* __ASM_R8A7790_H__ */
diff --git a/arch/arm/mach-shmobile/setup-r8a7790.c b/arch/arm/mach-shmobile/setup-r8a7790.c
index 70d5a23..5e833f4 100644
--- a/arch/arm/mach-shmobile/setup-r8a7790.c
+++ b/arch/arm/mach-shmobile/setup-r8a7790.c
@@ -141,6 +141,28 @@ static struct platform_device *r8a7790_early_devices[] __initdata = {
 
 /* DMA */
 /*  dma0:Audio-DMAC    */
+/*  dma1:Audio-DMAC-pp */
+static const struct sh_dmae_slave_config r8a7790_dma0_slaves[] = {
+	{
+		.slave_id	= SHDMA_SLAVE_MEM_SSI0,
+		.addr		= 0xec100000,
+		.chcr		= CHCR_TX(XMIT_SZ_32BIT),
+		.mid_rid	= 0x15,
+	}, {
+		.slave_id	= SHDMA_SLAVE_SSI1_MEM,
+		.addr		= 0xec101000,
+		.chcr		= CHCR_RX(XMIT_SZ_32BIT),
+		.mid_rid	= 0x4a,
+	},
+};
+
+static const struct sh_dmae_slave_config r8a7790_dma1_slaves[] = {
+	{
+		.slave_id	= SHDMA_SLAVE_SRC0_SSI0,
+	}, {
+		.slave_id	= SHDMA_SLAVE_SSI1_SRC1,
+	},
+};
 
 #define DMA_CHANNEL(a, b, c)			\
 {						\
@@ -212,6 +234,8 @@ static const struct sh_dmae_channel r8a7790_dma1_channels[] = {
 };
 
 static struct sh_dmae_pdata dma0_platform_data = {
+	.slave		= r8a7790_dma0_slaves,
+	.slave_num	= ARRAY_SIZE(r8a7790_dma0_slaves),
 	.channel	= r8a7790_dma0_channels,
 	.channel_num	= ARRAY_SIZE(r8a7790_dma0_channels),
 	.ts_low_shift	= TS_LOW_SHIFT,
@@ -225,6 +249,8 @@ static struct sh_dmae_pdata dma0_platform_data = {
 };
 
 static struct sh_dmae_pdata dma1_platform_data = {
+	.slave		= r8a7790_dma1_slaves,
+	.slave_num	= ARRAY_SIZE(r8a7790_dma1_slaves),
 	.channel	= r8a7790_dma1_channels,
 	.channel_num	= ARRAY_SIZE(r8a7790_dma1_channels),
 	.ts_low_shift	= TS_LOW_SHIFT,
-- 
1.7.10.4

