From 66fff6a58898af18939e54f563eaa2ff32cfb1a4 Mon Sep 17 00:00:00 2001
From: Shinobu Uehara <shinobu.uehara.xc@renesas.com>
Date: Wed, 26 Jun 2013 20:01:48 +0900
Subject: [PATCH 667/715] ARM: shmobile: r8a7790: Add xhci host driver support

Signed-off-by: Shinobu Uehara <shinobu.uehara.xc@renesas.com>
(cherry picked from commit 332ee0d50917bb514920158cf042135c5e629a3f)

Signed-off-by: Ryo Kataoka <ryo.kataoka.wt@renesas.com>
---
 arch/arm/mach-shmobile/clock-r8a7790.c        |    4 ++-
 arch/arm/mach-shmobile/include/mach/r8a7790.h |    3 ++
 arch/arm/mach-shmobile/setup-r8a7790.c        |   41 +++++++++++++++++++++++++
 3 files changed, 47 insertions(+), 1 deletion(-)

diff --git a/arch/arm/mach-shmobile/clock-r8a7790.c b/arch/arm/mach-shmobile/clock-r8a7790.c
index a9068d3..33b9a5e 100644
--- a/arch/arm/mach-shmobile/clock-r8a7790.c
+++ b/arch/arm/mach-shmobile/clock-r8a7790.c
@@ -200,7 +200,7 @@ static struct clk div6_clks[DIV6_NR] = {
 enum {
 	MSTP726, MSTP725, MSTP724, MSTP723, MSTP722, MSTP721, MSTP720,
 	MSTP717, MSTP716,
-	MSTP315, MSTP314, MSTP313, MSTP312, MSTP311, MSTP305, MSTP304,
+	MSTP328, MSTP315, MSTP314, MSTP313, MSTP312, MSTP311, MSTP305, MSTP304,
 	MSTP216, MSTP207, MSTP206, MSTP204, MSTP203, MSTP202,
 	MSTP112,
 	MSTP219, MSTP218,
@@ -221,6 +221,7 @@ static struct clk mstp_clks[MSTP_NR] = {
 	[MSTP722] = SH_CLK_MSTP32(&zx_clk, SMSTPCR7, 22, 0), /* DU2 */
 	[MSTP721] = SH_CLK_MSTP32(&p_clk, SMSTPCR7, 21, 0), /* SCIF0 */
 	[MSTP720] = SH_CLK_MSTP32(&p_clk, SMSTPCR7, 20, 0), /* SCIF1 */
+	[MSTP328] = SH_CLK_MSTP32(&mp_clk, SMSTPCR3, 28, 0),
 	[MSTP315] = SH_CLK_MSTP32(&div6_clks[DIV6_MMC0], SMSTPCR3, 15, 0), /* MMC0 */
 	[MSTP314] = SH_CLK_MSTP32(&div4_clks[DIV4_SD0], SMSTPCR3, 14, 0), /* SDHI0 */
 	[MSTP313] = SH_CLK_MSTP32(&div4_clks[DIV4_SD1], SMSTPCR3, 13, 0), /* SDHI1 */
@@ -333,6 +334,7 @@ static struct clk_lookup lookups[] = {
 	CLKDEV_DEV_ID("sh_mmcif.1", &mstp_clks[MSTP305]),
 	CLKDEV_CON_ID("hs_usb", &mstp_clks[MSTP704]),
 	CLKDEV_CON_ID("usb_fck", &mstp_clks[MSTP703]),
+	CLKDEV_CON_ID("ss_usb", &mstp_clks[MSTP328]),
 	CLKDEV_DEV_ID("qspi.0", &mstp_clks[MSTP917]),
 	CLKDEV_DEV_ID("i2c-rcar.0", &mstp_clks[MSTP931]),
 	CLKDEV_DEV_ID("i2c-rcar.1", &mstp_clks[MSTP930]),
diff --git a/arch/arm/mach-shmobile/include/mach/r8a7790.h b/arch/arm/mach-shmobile/include/mach/r8a7790.h
index a1f112e..8173dc1 100644
--- a/arch/arm/mach-shmobile/include/mach/r8a7790.h
+++ b/arch/arm/mach-shmobile/include/mach/r8a7790.h
@@ -55,6 +55,9 @@ extern void r8a7790_add_device_to_domain(struct r8a7790_pm_domain *r8a7790_pd,
 #define SHUSBH_EHCI_BASE	(SHUSBH_BASE + 0x1000)
 #define SHUSBH_EHCI_SIZE	0x1000
 
+#define SHUSBH_XHCI_BASE	UL(0xEE000000)
+#define SHUSBH_XHCI_SIZE	0x0C00
+
 /* PCI Configuration Registers for AHB-PCI Bridge Registers */
 #define PCI_CONF_AHBPCI_BAS	(SHUSBH_BASE + 0x10000)
 #define VID_DID			0x0000
diff --git a/arch/arm/mach-shmobile/setup-r8a7790.c b/arch/arm/mach-shmobile/setup-r8a7790.c
index 4820b61..33a5559 100644
--- a/arch/arm/mach-shmobile/setup-r8a7790.c
+++ b/arch/arm/mach-shmobile/setup-r8a7790.c
@@ -379,6 +379,29 @@ struct platform_device ohci2_device = {
 	.resource	= ohci2_resources,
 };
 
+static struct resource xhci0_resources[] = {
+	[0] = {
+		.start	= SHUSBH_XHCI_BASE,
+		.end	= SHUSBH_XHCI_BASE + SHUSBH_XHCI_SIZE - 1,
+		.flags	= IORESOURCE_MEM,
+	},
+	[1] = {
+		.start	= gic_spi(101),
+		.flags	= IORESOURCE_IRQ,
+	},
+};
+
+struct platform_device xhci0_device = {
+	.name	= "xhci-hcd",
+	.id	= 0,
+	.dev	= {
+		.dma_mask		= &usb_dmamask,
+		.coherent_dma_mask	= 0xffffffff,
+	},
+	.num_resources	= ARRAY_SIZE(xhci0_resources),
+	.resource	= xhci0_resources,
+};
+
 static void __init usbh_internal_pci_bridge_init(int ch)
 {
 	u32 data;
@@ -520,6 +543,9 @@ static void __init usbh_pci_int_enable(int ch)
 static int __init usbh_init(void)
 {
 	struct clk *clk_hs, *clk_ehci;
+#if defined(CONFIG_USB_XHCI_HCD)
+	struct clk *clk_xhci;
+#endif /* CONFIG_USB_XHCI_HCD */
 	void __iomem *hs_usb = ioremap_nocache(0xE6590000, 0x1ff);
 	unsigned int ch;
 
@@ -535,8 +561,19 @@ static int __init usbh_init(void)
 
 	clk_enable(clk_ehci);
 
+#if defined(CONFIG_USB_XHCI_HCD)
+	clk_xhci = clk_get(NULL, "ss_usb");
+	if (IS_ERR(clk_xhci))
+		clk_xhci = NULL;
+
+	clk_enable(clk_xhci);
+
+	/* Select XHCI for ch2 and EHCI for ch0 */
+	iowrite32(0x80000011, (hs_usb + 0x184));
+#else
 	/* Set EHCI for UGCTRL2 */
 	iowrite32(0x00000011, (hs_usb + 0x184));
+#endif /* CONFIG_USB_XHCI_HCD */
 
 	for (ch = 0; ch < SHUSBH_MAX_CH; ch++) {
 		/* internal pci-bus bridge initialize */
@@ -1421,8 +1458,12 @@ static struct platform_device *r8a7790_early_devices[] __initdata = {
 	&ohci0_device,
 	&ehci1_device,
 	&ohci1_device,
+#if defined(CONFIG_USB_XHCI_HCD)
+	&xhci0_device,
+#else
 	&ehci2_device,
 	&ohci2_device,
+#endif /* CONFIG_USB_XHCI_HCD */
 	&sdhi0_device,
 	&sdhi1_device,
 	&sdhi2_device,
-- 
1.7.10.4

