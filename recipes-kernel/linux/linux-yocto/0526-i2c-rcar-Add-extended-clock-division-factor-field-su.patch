From 790a4c4e7205d5f9eae5549e316e930aaa804e25 Mon Sep 17 00:00:00 2001
From: Shunsuke Kataoka <shunsuke.kataoka.df@renesas.com>
Date: Thu, 13 Jun 2013 13:08:31 +0900
Subject: [PATCH 526/715] i2c: rcar: Add extended clock division factor field
 support

Signed-off-by: Shunsuke Kataoka <shunsuke.kataoka.df@renesas.com>
(cherry picked from commit fd1d453b9fb752d7b1859a2d33c74700e6dba600)

Signed-off-by: Ryo Kataoka <ryo.kataoka.wt@renesas.com>
---
 drivers/i2c/busses/i2c-rcar.c |   11 +++++++++--
 include/linux/i2c/i2c-rcar.h  |    3 +++
 2 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/drivers/i2c/busses/i2c-rcar.c b/drivers/i2c/busses/i2c-rcar.c
index 72a8071..bc3c7ab 100644
--- a/drivers/i2c/busses/i2c-rcar.c
+++ b/drivers/i2c/busses/i2c-rcar.c
@@ -1,6 +1,8 @@
 /*
  *  drivers/i2c/busses/i2c-rcar.c
  *
+ * Copyright (C) 2013 Renesas Electronics Corporation
+ *
  * Copyright (C) 2012 Renesas Solutions Corp.
  * Kuninori Morimoto <kuninori.morimoto.gx@renesas.com>
  *
@@ -221,15 +223,20 @@ static int rcar_i2c_clock_calculate(struct rcar_i2c_priv *priv,
 				    struct device *dev)
 {
 	struct clk *clkp = clk_get(NULL, "peripheral_clk");
+	struct i2c_rcar_platform_data *pdata = dev->platform_data;
 	u32 scgd, cdf;
 	u32 round, ick;
 	u32 scl;
+	u32 cdf_width = 0;
 
 	if (!clkp) {
 		dev_err(dev, "there is no peripheral_clk\n");
 		return -EIO;
 	}
 
+	if (pdata && pdata->icccr_cdf_width)
+		cdf_width = pdata->icccr_cdf_width;
+
 	/*
 	 * calculate SCL clock
 	 * see
@@ -245,7 +252,7 @@ static int rcar_i2c_clock_calculate(struct rcar_i2c_priv *priv,
 	 * clkp : peripheral_clk
 	 * F[]  : integer up-valuation
 	 */
-	for (cdf = 0; cdf < 4; cdf++) {
+	for (cdf = 0; cdf < (4 << cdf_width); cdf++) {
 		ick = clk_get_rate(clkp) / (1 + cdf);
 		if (ick < 20000000)
 			goto ick_find;
@@ -287,7 +294,7 @@ scgd_find:
 	/*
 	 * keep icccr value
 	 */
-	priv->icccr = (scgd << 2 | cdf);
+	priv->icccr = (scgd << (2 + cdf_width) | cdf);
 
 	return 0;
 }
diff --git a/include/linux/i2c/i2c-rcar.h b/include/linux/i2c/i2c-rcar.h
index 496f5c2..6bf5b89 100644
--- a/include/linux/i2c/i2c-rcar.h
+++ b/include/linux/i2c/i2c-rcar.h
@@ -5,6 +5,9 @@
 
 struct i2c_rcar_platform_data {
 	u32 bus_speed;
+	u32 icccr_cdf_width;
+#define I2C_RCAR_ICCCR_IS_2BIT	0
+#define I2C_RCAR_ICCCR_IS_3BIT	1
 };
 
 #endif /* __I2C_R_CAR_H__ */
-- 
1.7.10.4

