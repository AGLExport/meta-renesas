From 06c7a6e4c168309fa093dd1be4f69a66d2264992 Mon Sep 17 00:00:00 2001
From: Kunihito Higashiyama <kunihito.higashiyama.ur@renesas.com>
Date: Mon, 29 Jul 2013 13:31:36 +0900
Subject: [PATCH 0768/1083] ARM: shmobile: r8a7791: Add MSIOF driver support

Signed-off-by: Kunihito Higashiyama <kunihito.higashiyama.ur@renesas.com>
---
 arch/arm/mach-shmobile/clock-r8a7791.c |  8 ++++
 arch/arm/mach-shmobile/setup-r8a7791.c | 75 ++++++++++++++++++++++++++++++++++
 2 files changed, 83 insertions(+)

diff --git a/arch/arm/mach-shmobile/clock-r8a7791.c b/arch/arm/mach-shmobile/clock-r8a7791.c
index ce5adbe..c3469b8 100644
--- a/arch/arm/mach-shmobile/clock-r8a7791.c
+++ b/arch/arm/mach-shmobile/clock-r8a7791.c
@@ -48,6 +48,7 @@
 #define CPG_BASE 0xe6150000
 #define CPG_LEN 0x1000
 
+#define SMSTPCR0	0xE6150130
 #define SMSTPCR1	0xE6150134
 #define SMSTPCR2	0xe6150138
 #define SMSTPCR3	0xE615013C
@@ -120,6 +121,7 @@ enum {
 	MSTP219, MSTP218,
 	MSTP502, MSTP501,
 	MSTP721, MSTP720,
+	MSTP000, MSTP208, MSTP205,
 	MSTP931, MSTP930, MSTP929, MSTP928, MSTP927, MSTP925,
 	MSTP_NR
 };
@@ -131,6 +133,9 @@ static struct clk mstp_clks[MSTP_NR] = {
 	[MSTP501] = SH_CLK_MSTP32(&hp_clk, SMSTPCR5, 1, 0),
 	[MSTP721] = SH_CLK_MSTP32(&p_clk, SMSTPCR7, 21, 0), /* SCIF0 */
 	[MSTP720] = SH_CLK_MSTP32(&p_clk, SMSTPCR7, 20, 0), /* SCIF1 */
+	[MSTP000] = SH_CLK_MSTP32(&mp_clk, SMSTPCR0, 0, 0), /* MSIOF0 */
+	[MSTP208] = SH_CLK_MSTP32(&mp_clk, SMSTPCR2, 8, 0), /* MSIOF1 */
+	[MSTP205] = SH_CLK_MSTP32(&mp_clk, SMSTPCR2, 5, 0), /* MSIOF2 */
 	[MSTP931] = SH_CLK_MSTP32(&hp_clk, SMSTPCR9, 31, 0),
 	[MSTP930] = SH_CLK_MSTP32(&hp_clk, SMSTPCR9, 30, 0),
 	[MSTP929] = SH_CLK_MSTP32(&hp_clk, SMSTPCR9, 29, 0),
@@ -161,6 +166,9 @@ static struct clk_lookup lookups[] = {
 	CLKDEV_CON_ID("audmac_up", &mstp_clks[MSTP501]),
 	CLKDEV_DEV_ID("sh-sci.6", &mstp_clks[MSTP721]),
 	CLKDEV_DEV_ID("sh-sci.7", &mstp_clks[MSTP720]),
+	CLKDEV_DEV_ID("spi_sh_msiof.1", &mstp_clks[MSTP000]),
+	CLKDEV_DEV_ID("spi_sh_msiof.2", &mstp_clks[MSTP208]),
+	CLKDEV_DEV_ID("spi_sh_msiof.3", &mstp_clks[MSTP205]),
 	CLKDEV_DEV_ID("i2c-rcar.0", &mstp_clks[MSTP931]),
 	CLKDEV_DEV_ID("i2c-rcar.1", &mstp_clks[MSTP930]),
 	CLKDEV_DEV_ID("i2c-rcar.2", &mstp_clks[MSTP929]),
diff --git a/arch/arm/mach-shmobile/setup-r8a7791.c b/arch/arm/mach-shmobile/setup-r8a7791.c
index 0faeb35..14aed93 100644
--- a/arch/arm/mach-shmobile/setup-r8a7791.c
+++ b/arch/arm/mach-shmobile/setup-r8a7791.c
@@ -752,6 +752,78 @@ static struct platform_device sysdmau_device = {
 	},
 };
 
+/* MSIOF */
+static struct sh_msiof_spi_info sh_msiof_info = {
+	.rx_fifo_override	= 256,
+	.num_chipselect		= 1,
+};
+
+static struct resource sh_msiof0_resources[] = {
+	[0] = {
+		.start	= 0xe6e20000,
+		.end	= 0xe6e20064,
+		.flags	= IORESOURCE_MEM,
+	},
+	[1] = {
+		.start	= gic_spi(156),
+		.flags	= IORESOURCE_IRQ,
+	},
+};
+
+static struct resource sh_msiof1_resources[] = {
+	[0] = {
+		.start	= 0xe6e10000,
+		.end	= 0xe6e10064,
+		.flags	= IORESOURCE_MEM,
+	},
+	[1] = {
+		.start	= gic_spi(157),
+		.flags	= IORESOURCE_IRQ,
+	},
+};
+
+static struct resource sh_msiof2_resources[] = {
+	[0] = {
+		.start	= 0xe6e00000,
+		.end	= 0xe6e00064,
+		.flags	= IORESOURCE_MEM,
+	},
+	[1] = {
+		.start	= gic_spi(158),
+		.flags	= IORESOURCE_IRQ,
+	},
+};
+
+static struct platform_device sh_msiof0_device = {
+	.name		= "spi_sh_msiof",
+	.id		= 1,
+	.dev		= {
+		.platform_data	= &sh_msiof_info,
+	},
+	.num_resources	= ARRAY_SIZE(sh_msiof0_resources),
+	.resource	= sh_msiof0_resources,
+};
+
+static struct platform_device sh_msiof1_device = {
+	.name		= "spi_sh_msiof",
+	.id		= 2,
+	.dev		= {
+		.platform_data	= &sh_msiof_info,
+	},
+	.num_resources	= ARRAY_SIZE(sh_msiof1_resources),
+	.resource	= sh_msiof1_resources,
+};
+
+static struct platform_device sh_msiof2_device = {
+	.name		= "spi_sh_msiof",
+	.id		= 3,
+	.dev		= {
+		.platform_data	= &sh_msiof_info,
+	},
+	.num_resources	= ARRAY_SIZE(sh_msiof2_resources),
+	.resource	= sh_msiof2_resources,
+};
+
 static struct platform_device *r8a7791_early_devices[] __initdata = {
 	&eth_device,
 	&i2c0_device,
@@ -765,6 +837,9 @@ static struct platform_device *r8a7791_early_devices[] __initdata = {
 	&audmapp_device,
 	&sysdmal_device,
 	&sysdmau_device,
+	&sh_msiof0_device,
+	&sh_msiof1_device,
+	&sh_msiof2_device,
 };
 
 static struct renesas_irqc_config irqc0_data = {
-- 
1.8.3.2

