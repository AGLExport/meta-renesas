From ac87e52a2e2fdce63a5b1e2dd681b45298e442ba Mon Sep 17 00:00:00 2001
From: Kunihito Higashiyama <kunihito.higashiyama.ur@renesas.com>
Date: Mon, 29 Jul 2013 13:49:04 +0900
Subject: [PATCH 0770/1083] ARM: shmobile: r8a7791: Add QSPI driver support

Signed-off-by: Kunihito Higashiyama <kunihito.higashiyama.ur@renesas.com>
---
 arch/arm/mach-shmobile/clock-r8a7791.c | 11 +++++++++++
 arch/arm/mach-shmobile/setup-r8a7791.c | 22 ++++++++++++++++++++++
 2 files changed, 33 insertions(+)

diff --git a/arch/arm/mach-shmobile/clock-r8a7791.c b/arch/arm/mach-shmobile/clock-r8a7791.c
index c3469b8..8704575 100644
--- a/arch/arm/mach-shmobile/clock-r8a7791.c
+++ b/arch/arm/mach-shmobile/clock-r8a7791.c
@@ -92,6 +92,7 @@ static struct clk main_clk = {
  */
 SH_FIXED_RATIO_CLK_SET(pll1_clk,		main_clk,	1, 1);
 SH_FIXED_RATIO_CLK_SET(pll3_clk,		main_clk,	1, 1);
+SH_FIXED_RATIO_CLK_SET(qspi_clk,		pll1_clk,	1, 1);
 
 /* fixed ratio clock */
 SH_FIXED_RATIO_CLK_SET(extal_div2_clk,		extal_clk,	1, 2);
@@ -110,6 +111,7 @@ static struct clk *main_clks[] = {
 	&pll1_clk,
 	&pll1_div2_clk,
 	&pll3_clk,
+	&qspi_clk,
 	&hp_clk,
 	&p_clk,
 	&mp_clk,
@@ -122,6 +124,7 @@ enum {
 	MSTP502, MSTP501,
 	MSTP721, MSTP720,
 	MSTP000, MSTP208, MSTP205,
+	MSTP917,
 	MSTP931, MSTP930, MSTP929, MSTP928, MSTP927, MSTP925,
 	MSTP_NR
 };
@@ -133,6 +136,7 @@ static struct clk mstp_clks[MSTP_NR] = {
 	[MSTP501] = SH_CLK_MSTP32(&hp_clk, SMSTPCR5, 1, 0),
 	[MSTP721] = SH_CLK_MSTP32(&p_clk, SMSTPCR7, 21, 0), /* SCIF0 */
 	[MSTP720] = SH_CLK_MSTP32(&p_clk, SMSTPCR7, 20, 0), /* SCIF1 */
+	[MSTP917] = SH_CLK_MSTP32(&qspi_clk, SMSTPCR9, 17, 0), /* QSPI */
 	[MSTP000] = SH_CLK_MSTP32(&mp_clk, SMSTPCR0, 0, 0), /* MSIOF0 */
 	[MSTP208] = SH_CLK_MSTP32(&mp_clk, SMSTPCR2, 8, 0), /* MSIOF1 */
 	[MSTP205] = SH_CLK_MSTP32(&mp_clk, SMSTPCR2, 5, 0), /* MSIOF2 */
@@ -153,6 +157,7 @@ static struct clk_lookup lookups[] = {
 	CLKDEV_CON_ID("pll1",		&pll1_clk),
 	CLKDEV_CON_ID("pll1_div2",	&pll1_div2_clk),
 	CLKDEV_CON_ID("pll3",		&pll3_clk),
+	CLKDEV_CON_ID("qspi",           &qspi_clk),
 	CLKDEV_CON_ID("hp",		&hp_clk),
 	CLKDEV_CON_ID("p",		&p_clk),
 	CLKDEV_CON_ID("mp",		&mp_clk),
@@ -166,6 +171,7 @@ static struct clk_lookup lookups[] = {
 	CLKDEV_CON_ID("audmac_up", &mstp_clks[MSTP501]),
 	CLKDEV_DEV_ID("sh-sci.6", &mstp_clks[MSTP721]),
 	CLKDEV_DEV_ID("sh-sci.7", &mstp_clks[MSTP720]),
+	CLKDEV_DEV_ID("qspi.0", &mstp_clks[MSTP917]),
 	CLKDEV_DEV_ID("spi_sh_msiof.1", &mstp_clks[MSTP000]),
 	CLKDEV_DEV_ID("spi_sh_msiof.2", &mstp_clks[MSTP208]),
 	CLKDEV_DEV_ID("spi_sh_msiof.3", &mstp_clks[MSTP205]),
@@ -212,6 +218,11 @@ void __init r8a7791_clock_init(void)
 		break;
 	}
 
+	if ((mode & (MD(3) | MD(2) | MD(1))) == MD(2))
+		SH_CLK_SET_RATIO(&qspi_clk_ratio, 1, 16);
+	else
+		SH_CLK_SET_RATIO(&qspi_clk_ratio, 1, 20);
+
 	for (k = 0; !ret && (k < ARRAY_SIZE(main_clks)); k++)
 		ret = clk_register(main_clks[k]);
 
diff --git a/arch/arm/mach-shmobile/setup-r8a7791.c b/arch/arm/mach-shmobile/setup-r8a7791.c
index 14aed93..99617a4 100644
--- a/arch/arm/mach-shmobile/setup-r8a7791.c
+++ b/arch/arm/mach-shmobile/setup-r8a7791.c
@@ -752,6 +752,27 @@ static struct platform_device sysdmau_device = {
 	},
 };
 
+/* QSPI */
+static struct resource qspi_resources[] = {
+	[0] = {
+		.name	= "QSPI",
+		.start	= 0xe6b10000,
+		.end	= 0xe6b10fff,
+		.flags	= IORESOURCE_MEM,
+	},
+	[1] = {
+		.start	= gic_spi(184),
+		.flags	= IORESOURCE_IRQ,
+	},
+};
+
+static struct platform_device qspi_device = {
+	.name		= "qspi",
+	.id		= 0,
+	.num_resources	= ARRAY_SIZE(qspi_resources),
+	.resource	= qspi_resources,
+};
+
 /* MSIOF */
 static struct sh_msiof_spi_info sh_msiof_info = {
 	.rx_fifo_override	= 256,
@@ -837,6 +858,7 @@ static struct platform_device *r8a7791_early_devices[] __initdata = {
 	&audmapp_device,
 	&sysdmal_device,
 	&sysdmau_device,
+	&qspi_device,
 	&sh_msiof0_device,
 	&sh_msiof1_device,
 	&sh_msiof2_device,
-- 
1.8.3.2

