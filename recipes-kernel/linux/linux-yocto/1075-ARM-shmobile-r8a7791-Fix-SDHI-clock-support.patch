From 2be79f8f0123d48056ca61442d3ada37170b0d4b Mon Sep 17 00:00:00 2001
From: Shinobu Uehara <shinobu.uehara.xc@renesas.com>
Date: Tue, 6 Aug 2013 17:19:50 +0900
Subject: [PATCH 1075/1083] ARM: shmobile: r8a7791: Fix SDHI clock support

Signed-off-by: Shinobu Uehara <shinobu.uehara.xc@renesas.com>
---
 arch/arm/mach-shmobile/clock-r8a7791.c | 33 ++++++++++++++++++++++++---------
 1 file changed, 24 insertions(+), 9 deletions(-)

diff --git a/arch/arm/mach-shmobile/clock-r8a7791.c b/arch/arm/mach-shmobile/clock-r8a7791.c
index 9fd4229..83dd3e6 100644
--- a/arch/arm/mach-shmobile/clock-r8a7791.c
+++ b/arch/arm/mach-shmobile/clock-r8a7791.c
@@ -339,21 +339,36 @@ static struct clk_lookup lookups[] = {
 
 static void __init r8a7791_sdhi_clock_init(void)
 {
-	struct clk *sdhi1_clk, *sdhi2_clk;
+	int ret = 0;
+	struct clk *sdhi_clk;
 
 	/* set SDHI1 clock to 97.5 MHz */
-	sdhi1_clk = clk_get(NULL, "sdhi1");
-	if (!IS_ERR(sdhi1_clk)) {
-		clk_set_rate(sdhi1_clk, 97500000);
-		clk_put(sdhi1_clk);
+	sdhi_clk = clk_get(NULL, "sdhi1");
+	if (IS_ERR(sdhi_clk)) {
+		pr_err("Cannot get sdhi1 clock\n");
+		goto sdhi1_out;
 	}
+	ret = clk_set_rate(sdhi_clk, 97500000);
+	if (ret < 0)
+		pr_err("Cannot set sdhi1 clock rate :%d\n", ret);
+
+	clk_put(sdhi_clk);
+sdhi1_out:
 
 	/* set SDHI2 clock to 97.5 MHz */
-	sdhi2_clk = clk_get(NULL, "sdhi2");
-	if (!IS_ERR(sdhi2_clk)) {
-		clk_set_rate(sdhi2_clk, 97500000);
-		clk_put(sdhi2_clk);
+	sdhi_clk = clk_get(NULL, "sdhi2");
+	if (IS_ERR(sdhi_clk)) {
+		pr_err("Cannot get sdhi2 clock\n");
+		goto sdhi2_out;
 	}
+	ret = clk_set_rate(sdhi_clk, 97500000);
+	if (ret < 0)
+		pr_err("Cannot set sdhi2 clock rate :%d\n", ret);
+
+	clk_put(sdhi_clk);
+sdhi2_out:
+
+	return;
 }
 
 static int __init r8a7791_mmc_clock_init(void)
-- 
1.8.3.2

