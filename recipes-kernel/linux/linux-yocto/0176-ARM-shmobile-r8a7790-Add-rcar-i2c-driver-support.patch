From e56e52e992807d5bd85ace258e98e2a6b0e34673 Mon Sep 17 00:00:00 2001
From: Shunsuke Kataoka <shunsuke.kataoka.df@renesas.com>
Date: Thu, 11 Apr 2013 14:02:17 +0900
Subject: ARM: shmobile: r8a7790: Add rcar-i2c driver support

Signed-off-by: Kouei Abe <kouei.abe.cp@renesas.com>
---
 arch/arm/configs/lager_defconfig       |    2 ++
 arch/arm/mach-shmobile/board-lager.c   |    4 ++++
 arch/arm/mach-shmobile/clock-r8a7790.c |    1 +
 arch/arm/mach-shmobile/setup-r8a7790.c |   29 +++++++++++++++++++++++++++++
 4 files changed, 36 insertions(+)

diff --git a/arch/arm/configs/lager_defconfig b/arch/arm/configs/lager_defconfig
index e876bb0..c627d83 100644
--- a/arch/arm/configs/lager_defconfig
+++ b/arch/arm/configs/lager_defconfig
@@ -74,6 +74,8 @@ CONFIG_SERIAL_SH_SCI=y
 CONFIG_SERIAL_SH_SCI_NR_UARTS=2
 CONFIG_SERIAL_SH_SCI_CONSOLE=y
 # CONFIG_HW_RANDOM is not set
+CONFIG_I2C_CHARDEV=y
+CONFIG_I2C_RCAR=y
 CONFIG_GPIO_SYSFS=y
 # CONFIG_HWMON is not set
 CONFIG_SSB=y
diff --git a/arch/arm/mach-shmobile/board-lager.c b/arch/arm/mach-shmobile/board-lager.c
index 4ef11f4..4cdd079 100644
--- a/arch/arm/mach-shmobile/board-lager.c
+++ b/arch/arm/mach-shmobile/board-lager.c
@@ -402,6 +402,10 @@ static void __init lager_init(void)
 {
 	r8a7790_pinmux_init();
 
+	/* I2C2 */
+	gpio_request(GPIO_FN_SCL2_CIS, NULL);
+	gpio_request(GPIO_FN_SDA2_CIS, NULL);
+
 	/* DU */
 	gpio_request(GPIO_FN_DU_DOTCLKIN0, NULL);
 	gpio_request(GPIO_FN_DU0_DOTCLKOUT, NULL);
diff --git a/arch/arm/mach-shmobile/clock-r8a7790.c b/arch/arm/mach-shmobile/clock-r8a7790.c
index ab0c41b..60b48aa 100644
--- a/arch/arm/mach-shmobile/clock-r8a7790.c
+++ b/arch/arm/mach-shmobile/clock-r8a7790.c
@@ -180,6 +180,7 @@ static struct clk_lookup lookups[] = {
 	CLKDEV_CON_ID("hp_clk", &hp_clk),
 	CLKDEV_CON_ID("mp_clk", &mp_clk),
 	CLKDEV_CON_ID("cp_clk", &cp_clk),
+	CLKDEV_CON_ID("peripheral_clk", &hp_clk),
 
 	CLKDEV_CON_ID("g6400", &mstp_clks[MSTP112]),
 	CLKDEV_DEV_ID("rcar-du.0", &mstp_clks[MSTP724]),
diff --git a/arch/arm/mach-shmobile/setup-r8a7790.c b/arch/arm/mach-shmobile/setup-r8a7790.c
index ccb1164..68993ea 100644
--- a/arch/arm/mach-shmobile/setup-r8a7790.c
+++ b/arch/arm/mach-shmobile/setup-r8a7790.c
@@ -25,6 +25,7 @@
 #include <linux/of_platform.h>
 #include <linux/serial_sci.h>
 #include <linux/sh_eth.h>
+#include <linux/i2c/i2c-rcar.h>
 #include <mach/r8a7790.h>
 #include <mach/irqs.h>
 #include <linux/platform_data/rcar-du.h>
@@ -68,6 +69,33 @@ static struct platform_device eth_device = {
 	.resource = eth_resources,
 };
 
+/* I2C */
+static struct i2c_rcar_platform_data i2c_pd = {
+	.bus_speed	= 400000,
+	.icccr_cdf_width = I2C_RCAR_ICCCR_IS_3BIT,
+};
+
+static struct resource rcar_i2c2_res[] = {
+	{
+		.start  = 0xe6530000,
+		.end    = (0xe6540000 - 1),
+		.flags  = IORESOURCE_MEM,
+	}, {
+		.start  = gic_spi(286),
+		.flags  = IORESOURCE_IRQ,
+	},
+};
+
+static struct platform_device i2c2_device = {
+	.name		= "i2c-rcar",
+	.id		= 2,
+	.dev = {
+		.platform_data = &i2c_pd,
+	},
+	.num_resources	= ARRAY_SIZE(rcar_i2c2_res),
+	.resource	= rcar_i2c2_res,
+};
+
 /* DU */
 static struct resource rcar_du_resources[] = {
 	[0] = {
@@ -106,6 +134,7 @@ static struct platform_device rcar_du_device = {
 
 static struct platform_device *r8a7790_early_devices[] __initdata = {
 	&eth_device,
+	&i2c2_device,
 	&rcar_du_device,
 };
 
-- 
1.7.10.4

