From c25756bc6f8776cf05e6d6054075effa1ded3a3b Mon Sep 17 00:00:00 2001
From: Shinobu Uehara <shinobu.uehara.xc@renesas.com>
Date: Fri, 14 Jun 2013 15:07:05 +0900
Subject: [PATCH 512/715] mmc: card: Add single read option in two blocks
 access

Signed-off-by: Shinobu Uehara <shinobu.uehara.xc@renesas.com>
(cherry picked from commit 29296cfce4db5f5be959ce91f1a121c135f00b6b)

Signed-off-by: Ryo Kataoka <ryo.kataoka.wt@renesas.com>
---
 drivers/mmc/card/block.c |    6 ++++++
 include/linux/mmc/host.h |    1 +
 2 files changed, 7 insertions(+)

diff --git a/drivers/mmc/card/block.c b/drivers/mmc/card/block.c
index 6352aea..ddc5664 100644
--- a/drivers/mmc/card/block.c
+++ b/drivers/mmc/card/block.c
@@ -1,6 +1,7 @@
 /*
  * Block driver for media (i.e., flash cards)
  *
+ * Copyright (C) 2013 Renesas Electronics Corporation
  * Copyright 2002 Hewlett-Packard Company
  * Copyright 2005-2008 Pierre Ossman
  *
@@ -1138,6 +1139,11 @@ static void mmc_blk_rw_rq_prep(struct mmc_queue_req *mqrq,
 		if (card->host->caps2 & MMC_CAP2_NO_MULTI_READ &&
 		    rq_data_dir(req) == READ)
 			brq->data.blocks = 1;
+		/* Some controllers can't do multiblock reads for 2 blocks
+		 due to hw bugs */
+		if (card->host->caps2 & MMC_CAP2_NO_2BLKS_READ &&
+		    rq_data_dir(req) == READ && brq->data.blocks == 2)
+			brq->data.blocks = 1;
 	}
 
 	if (brq->data.blocks > 1 || do_rel_wr) {
diff --git a/include/linux/mmc/host.h b/include/linux/mmc/host.h
index 65c64ee..b093dd2 100644
--- a/include/linux/mmc/host.h
+++ b/include/linux/mmc/host.h
@@ -261,6 +261,7 @@ struct mmc_host {
 #define MMC_CAP2_HC_ERASE_SZ	(1 << 9)	/* High-capacity erase size */
 #define MMC_CAP2_CD_ACTIVE_HIGH	(1 << 10)	/* Card-detect signal active high */
 #define MMC_CAP2_RO_ACTIVE_HIGH	(1 << 11)	/* Write-protect signal active high */
+#define MMC_CAP2_NO_2BLKS_READ	(1 << 12)	/* Singleblock read is only 2 blocks */
 
 	mmc_pm_flag_t		pm_caps;	/* supported pm features */
 	unsigned int        power_notify_type;
-- 
1.7.10.4

