From 9180f1a0067960daf7219fe0d5f7cfec36826ccf Mon Sep 17 00:00:00 2001
From: Koji Matsuoka <koji.matsuoka.xm@renesas.com>
Date: Wed, 31 Jul 2013 17:35:09 +0900
Subject: [PATCH 1065/1083] drm: rcar-du: Add external clock use feature

The external clock is used for HDMI in r8a7790.

Signed-off-by: Koji Matsuoka <koji.matsuoka.xm@renesas.com>
---
 drivers/gpu/drm/rcar-du/rcar_du_crtc.c | 19 +++++++++++++------
 drivers/gpu/drm/rcar-du/rcar_du_drv.c  |  3 ++-
 drivers/gpu/drm/rcar-du/rcar_du_drv.h  |  1 +
 3 files changed, 16 insertions(+), 7 deletions(-)

diff --git a/drivers/gpu/drm/rcar-du/rcar_du_crtc.c b/drivers/gpu/drm/rcar-du/rcar_du_crtc.c
index 25d074c..534443d 100644
--- a/drivers/gpu/drm/rcar-du/rcar_du_crtc.c
+++ b/drivers/gpu/drm/rcar-du/rcar_du_crtc.c
@@ -98,12 +98,19 @@ static void rcar_du_crtc_set_display_timing(struct rcar_du_crtc *rcrtc)
 	div = DIV_ROUND_CLOSEST(clk, mode->clock * 1000);
 	div = clamp(div, 1U, 64U) - 1;
 
-	if (strcmp(mode->name, "1920x1080") == 0)
-		rcar_du_group_write(rcrtc->group, rcrtc->index % 2 ? ESCR2 :
-			ESCR, 0);
-	else
-		rcar_du_group_write(rcrtc->group, rcrtc->index % 2 ? ESCR2 :
-			ESCR, ESCR_DCLKSEL_CLKS | div);
+	if ((strcmp(mode->name, "1920x1080") == 0) &&
+		 (rcrtc->outputs != (1 << RCAR_DU_OUTPUT_DPAD0)) &&
+		 (rcrtc->outputs != (1 << RCAR_DU_OUTPUT_LVDS1))) {
+		if (rcar_du_has(rcrtc->group->dev,
+				 RCAR_DU_FEATURE_EXTERAL_CLOCK))
+			rcar_du_group_write(rcrtc->group, rcrtc->index % 2 ?
+				ESCR2 : ESCR, 0);
+		else
+			rcar_du_group_write(rcrtc->group, rcrtc->index % 2 ?
+				ESCR2 : ESCR, ESCR_DCLKSEL_CLKS | div);
+	} else
+		rcar_du_group_write(rcrtc->group, rcrtc->index % 2 ?
+			ESCR2 : ESCR, ESCR_DCLKSEL_CLKS | div);
 	rcar_du_group_write(rcrtc->group, rcrtc->index % 2 ? OTAR2 : OTAR, 0);
 
 	/* Signal polarities */
diff --git a/drivers/gpu/drm/rcar-du/rcar_du_drv.c b/drivers/gpu/drm/rcar-du/rcar_du_drv.c
index 25bf91c..9a6efe3 100644
--- a/drivers/gpu/drm/rcar-du/rcar_du_drv.c
+++ b/drivers/gpu/drm/rcar-du/rcar_du_drv.c
@@ -247,7 +247,8 @@ static const struct rcar_du_device_info rcar_du_r8a7779_info = {
 static const struct rcar_du_device_info rcar_du_r8a7790_info = {
 	.features = RCAR_DU_FEATURE_CRTC_IRQ_CLOCK | RCAR_DU_FEATURE_ALIGN_128B
 		  | RCAR_DU_FEATURE_DEFR8 | RCAR_DU_FEATURE_VSP1_SOURCE
-		  | RCAR_DU_FEATURE_LVDCHCR_WORKAROUND,
+		  | RCAR_DU_FEATURE_LVDCHCR_WORKAROUND
+		  | RCAR_DU_FEATURE_EXTERAL_CLOCK,
 	.num_crtcs = 3,
 	.routes = {
 		/* R8A7790 has one RGB output, two LVDS outputs and one
diff --git a/drivers/gpu/drm/rcar-du/rcar_du_drv.h b/drivers/gpu/drm/rcar-du/rcar_du_drv.h
index 7952db4..b932eb0 100644
--- a/drivers/gpu/drm/rcar-du/rcar_du_drv.h
+++ b/drivers/gpu/drm/rcar-du/rcar_du_drv.h
@@ -33,6 +33,7 @@ struct rcar_du_lvdsenc;
 #define RCAR_DU_FEATURE_VSP1_SOURCE	(1 << 3)	/* Has inputs from VSP1 */
 #define RCAR_DU_FEATURE_LVDCHCR_WORKAROUND	(1 << 4)
 #define RCAR_DU_FEATURE_NO_LVDS_INTERFACE	(1 << 5)
+#define RCAR_DU_FEATURE_EXTERAL_CLOCK	(1 << 6)
 
 /*
  * struct rcar_du_output_routing - Output routing specification
-- 
1.8.3.2

